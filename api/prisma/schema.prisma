generator client {
  provider = "prisma-client-js"
  output   = "./node_modules/@prisma/client"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  CLUB_LEADER
  FACULTY
  ADMIN
}

enum PostType {
  ANNOUNCEMENT
  EVENT_PROMOTION
  GENERAL
  POLL
  FEEDBACK
}

model User {
  id            Int              @id @default(autoincrement())
  name          String
  email         String              @unique
  password      String              // Must be hashed in application code!
  role          Role                @default(STUDENT)
  
  // Relations
  clubs         ClubMember[]
  events        EventRegistration[]
  posts         Post[]
  createdClubs  Club[]              @relation("ClubCreator")
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("users")
}

model Club {
  id            Int                 @id @default(autoincrement())
  name          String
  description   String?
  category      String
  createdBy     String
  creator       User                @relation("ClubCreator", fields: [createdBy], references: [id])

  members       ClubMember[]
  events        Event[]
  posts         Post[]

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([name])                    // Optional: prevent duplicate club names
  @@index([name])
  @@index([category])
  @@index([createdBy])
  @@map("clubs")
}

model ClubMember {
  id        Int       @id @default(autoincrement())
  clubId    Int
  userId    String
  role      String    @default("MEMBER") // e.g., PRESIDENT, VP, MEMBER
  joinedAt  DateTime  @default(now())

  club      Club      @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])          // Critical: one membership per user per club
  @@index([clubId])
  @@index([userId])
  @@map("club_members")
}

model Event {
  id            Int                 @id @default(autoincrement())
  clubId        Int
  title         String
  description   String?
  date          DateTime
  venue         String
  capacity      Int?

  club          Club                @relation(fields: [clubId], references: [id], onDelete: Cascade)
  registrations EventRegistration[]

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([clubId])
  @@index([date])
  @@map("events")
}

model EventRegistration {
  id            Int       @id @default(autoincrement())
  eventId       Int
  userId        String
  attended      Boolean   @default(false)
  registeredAt  DateTime  @default(now())

  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])         // Critical: prevent duplicate registrations
  @@index([eventId])
  @@index([userId])
  @@index([attended])
  @@map("event_registrations")
}

model Post {
  id        Int       @id @default(autoincrement())
  clubId    Int
  userId    String
  content   String
  type      PostType  @default(GENERAL)

  club      Club      @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([clubId])
  @@index([userId])
  @@index([createdAt])
  @@index([type])
  @@map("posts")
}
